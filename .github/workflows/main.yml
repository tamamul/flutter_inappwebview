name: Build Flutter APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        cache: true
        cache-key: flutter-packages
        cache-path: ${{ github.workspace }}/.pub-cache
        
    - name: Install FVM
      run: |
        dart pub global activate fvm
        echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
        
    - name: Check FVM config
      run: |
        if [ -f ".fvm/fvm_config.json" ]; then
          echo "FVM config found"
          cat .fvm/fvm_config.json
        else
          echo "No FVM config found, using default Flutter version"
        fi
        
    - name: Install Flutter dependencies
      run: |
        cd flutter_inappwebview/example
        flutter pub get
        
    - name: Run Build Runner
      run: |
        # Coba jalankan dengan FVM dulu, jika gagal gunakan Flutter langsung
        cd flutter_inappwebview_platform_interface
        if flutter pub run build_runner build --delete-conflicting-outputs; then
          echo "Build runner completed successfully"
        else
          echo "Build runner failed, trying alternative approach"
          flutter clean
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
        fi
        
    - name: Build APK
      run: |
        cd flutter_inappwebview/example
        flutter build apk --release --no-tree-shake-icons
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: flutter-app
        path: flutter_inappwebview/example/build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30
        
    - name: Create download page
      run: |
        cat > download.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Download Flutter App</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
                .download-btn { 
                    background: #007cba; 
                    color: white; 
                    padding: 15px 30px; 
                    text-decoration: none; 
                    border-radius: 5px; 
                    display: inline-block; 
                    margin: 20px; 
                    font-size: 18px;
                }
                .download-btn:hover { background: #005a87; }
                .info { margin: 20px 0; color: #666; }
            </style>
        </head>
        <body>
            <h1>Flutter InAppWebView Example App</h1>
            <div class="info">Built on: $(date)</div>
            <div class="info">Commit: ${{ github.sha }}</div>
            <a href="./app-release.apk" class="download-btn">Download APK</a>
            <div class="info">
                <p>To install:</p>
                <ol style="display: inline-block; text-align: left;">
                    <li>Download the APK file above</li>
                    <li>Enable "Install from unknown sources" in your Android settings</li>
                    <li>Open the downloaded file to install</li>
                </ol>
            </div>
        </body>
        </html>
        EOF
        
    - name: Upload download page
      uses: actions/upload-artifact@v4
      with:
        name: download-page
        path: download.html
        retention-days: 30
