name: Build Flutter APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Flutter (Latest Stable)
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.0'  # Versi terbaru yang support Dart 3.3.0+
        cache: true
        cache-key: flutter-packages
        cache-path: ${{ github.workspace }}/.pub-cache
        
    - name: Check Flutter and Dart Version
      run: |
        flutter --version
        dart --version
        
    - name: Install Dependencies (Root)
      run: |
        flutter pub get
        
    - name: Install Dependencies (Example)
      run: |
        cd flutter_inappwebview/example
        flutter pub get
        
    - name: Run Build Runner
      run: |
        cd flutter_inappwebview_platform_interface
        flutter pub run build_runner build --delete-conflicting-outputs
        
    - name: Build APK
      run: |
        cd flutter_inappwebview/example
        flutter build apk --release --no-tree-shake-icons
        
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: flutter-app-apk
        path: flutter_inappwebview/example/build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30
        
    - name: Create Download Page
      run: |
        cat > download.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Download Flutter App</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
                .download-btn { 
                    background: #007cba; 
                    color: white; 
                    padding: 15px 30px; 
                    text-decoration: none; 
                    border-radius: 5px; 
                    display: inline-block; 
                    margin: 20px; 
                    font-size: 18px;
                }
                .download-btn:hover { background: #005a87; }
                .info { margin: 20px 0; color: #666; }
                .commit-info { background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; }
            </style>
        </head>
        <body>
            <h1>Flutter InAppWebView Example App</h1>
            <div class="info">Built on: $(date -u)</div>
            <div class="commit-info">
                <strong>Commit:</strong> ${{ github.sha }}<br>
                <strong>Branch:</strong> ${{ github.ref_name }}
            </div>
            <a href="./app-release.apk" class="download-btn">Download APK</a>
            <div class="info">
                <p><strong>To install:</strong></p>
                <ol style="display: inline-block; text-align: left;">
                    <li>Download the APK file above</li>
                    <li>Enable "Install from unknown sources" in your Android settings</li>
                    <li>Open the downloaded file to install</li>
                </ol>
            </div>
        </body>
        </html>
        EOF
        
    - name: Upload Download Page
      uses: actions/upload-artifact@v4
      with:
        name: download-page
        path: download.html
        retention-days: 30

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Download APK Artifact
      uses: actions/download-artifact@v4
      with:
        name: flutter-app-apk
        path: public/
        
    - name: Download Page Artifact
      uses: actions/download-artifact@v4
      with:
        name: download-page
        path: public/
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: public/
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
